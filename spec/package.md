# Mica Package System Specification

This document defines the package management system for Mica projects.

## Overview

The Mica package system provides:
- Project initialization and management
- Dependency resolution from Git repositories
- Reproducible builds via lock files
- Module imports

## Project Structure

```
myproject/
├── pkg.toml           # Package manifest
├── pkg.lock           # Lock file (auto-generated)
└── src/
    ├── main.mica      # Entry point
    └── lib/
        └── helper.mica
```

## pkg.toml Format

```toml
[package]
name = "myapp"
version = "0.1.0"
entry = "src/main.mica"

[dependencies]
# Git URL + rev/tag/branch
utils = { git = "https://github.com/user/mica-utils", tag = "v1.0.0" }
json = { git = "https://github.com/user/mica-json", rev = "abc123" }

[dev-dependencies]
test-utils = { git = "https://github.com/user/mica-test" }
```

### Package Section

| Field | Description |
|-------|-------------|
| `name` | Package name |
| `version` | Semantic version |
| `entry` | Entry point file (default: `src/main.mica`) |

### Dependency Specification

Dependencies are specified with Git source:

```toml
# Using tag
utils = { git = "https://github.com/user/mica-utils", tag = "v1.0.0" }

# Using specific commit
json = { git = "https://github.com/user/mica-json", rev = "abc123" }

# Using branch (defaults to main/master)
lib = { git = "https://github.com/user/mica-lib" }
```

## pkg.lock Format

```toml
[[package]]
name = "utils"
version = "1.0.0"
source = "git+https://github.com/user/mica-utils?tag=v1.0.0"
checksum = "sha256:..."

[[package]]
name = "json"
version = "0.2.0"
source = "git+https://github.com/user/mica-json?rev=abc123"
checksum = "sha256:..."
```

The lock file:
- Is auto-generated by `mica add` or `mica update`
- Should be committed to version control
- Ensures reproducible builds

## Module Resolution

### Import Syntax

```
import utils.http;     // -> <cache>/utils/src/http.mica
import json;           // -> <cache>/json/src/main.mica (entry)
import ./local_mod;    // -> ./local_mod.mica (relative path)
```

### Resolution Order

1. Check for relative path import (`./` or `../`)
2. Check for dependency in `pkg.toml`
3. Check for local module in `src/`

## CLI Commands

### Create Project

```bash
mica init [name]
```

Creates a new project with:
- `pkg.toml` with default configuration
- `src/main.mica` with hello world

### Add Dependency

```bash
mica add <url>[@rev]
```

Examples:
```bash
mica add https://github.com/user/mica-utils
mica add https://github.com/user/mica-utils@v1.0.0
mica add https://github.com/user/mica-utils@abc123
```

### Remove Dependency

```bash
mica remove <name>
```

### Update Dependencies

```bash
mica update         # Update all
mica update <name>  # Update specific package
```

### Vendor Dependencies

```bash
mica vendor
```

Copies all dependencies to `vendor/` directory for offline builds.

## Dependency Cache

Dependencies are cached in:
- Linux: `~/.cache/mica/deps/`
- macOS: `~/Library/Caches/mica/deps/`
- Windows: `%LOCALAPPDATA%\mica\deps\`

## Example Workflow

### Create a New Project

```bash
$ mica init myapp
Created project 'myapp'

$ cd myapp
$ cat pkg.toml
[package]
name = "myapp"
version = "0.1.0"
entry = "src/main.mica"

[dependencies]

$ cat src/main.mica
print("Hello, World!");
```

### Add a Dependency

```bash
$ mica add https://github.com/user/mica-json@v1.0.0
Added json v1.0.0

$ cat pkg.toml
[package]
name = "myapp"
version = "0.1.0"
entry = "src/main.mica"

[dependencies]
json = { git = "https://github.com/user/mica-json", tag = "v1.0.0" }
```

### Use the Dependency

```mica
// src/main.mica
import json;

let data = json.parse('{"name": "mica"}');
print(data.name);
```

### Run the Project

```bash
$ mica run
mica
```
