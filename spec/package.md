---
title: Package System Specification
description: パッケージ管理システムの仕様。プロジェクト構造、依存関係解決、ロックファイルによる再現可能ビルドを定義。
---

# Moca Package System Specification

This document defines the package management system for Moca projects.

## Overview

The Moca package system provides:
- Project initialization and management
- Dependency resolution from Git repositories
- Reproducible builds via lock files
- Module imports

## Project Structure

```
myproject/
├── pkg.toml           # Package manifest
├── pkg.lock           # Lock file (auto-generated)
└── src/
    ├── main.mc        # Entry point
    └── lib/
        └── helper.mc
```

## pkg.toml Format

```toml
[package]
name = "myapp"
version = "0.1.0"
entry = "src/main.mc"

[dependencies]
# Git URL + rev/tag/branch
utils = { git = "https://github.com/user/moca-utils", tag = "v1.0.0" }
json = { git = "https://github.com/user/moca-json", rev = "abc123" }

[dev-dependencies]
test-utils = { git = "https://github.com/user/moca-test" }
```

### Package Section

| Field | Description |
|-------|-------------|
| `name` | Package name |
| `version` | Semantic version |
| `entry` | Entry point file (default: `src/main.mc`) |

### Dependency Specification

Dependencies are specified with Git source:

```toml
# Using tag
utils = { git = "https://github.com/user/moca-utils", tag = "v1.0.0" }

# Using specific commit
json = { git = "https://github.com/user/moca-json", rev = "abc123" }

# Using branch (defaults to main/master)
lib = { git = "https://github.com/user/moca-lib" }
```

## pkg.lock Format

```toml
[[package]]
name = "utils"
version = "1.0.0"
source = "git+https://github.com/user/moca-utils?tag=v1.0.0"
checksum = "sha256:..."

[[package]]
name = "json"
version = "0.2.0"
source = "git+https://github.com/user/moca-json?rev=abc123"
checksum = "sha256:..."
```

The lock file:
- Is auto-generated by `moca add` or `moca update`
- Should be committed to version control
- Ensures reproducible builds

## Module Resolution

### Import Syntax

```
import utils.http;     // -> <cache>/utils/src/http.mc
import json;           // -> <cache>/json/src/main.mc (entry)
import ./local_mod;    // -> ./local_mod.mc (relative path)
```

### Resolution Order

1. Check for relative path import (`./` or `../`)
2. Check for dependency in `pkg.toml`
3. Check for local module in `src/`

## CLI Commands

### Create Project

```bash
moca init [name]
```

Creates a new project with:
- `pkg.toml` with default configuration
- `src/main.mc` with hello world

### Add Dependency

```bash
moca add <url>[@rev]
```

Examples:
```bash
moca add https://github.com/user/moca-utils
moca add https://github.com/user/moca-utils@v1.0.0
moca add https://github.com/user/moca-utils@abc123
```

### Remove Dependency

```bash
moca remove <name>
```

### Update Dependencies

```bash
moca update         # Update all
moca update <name>  # Update specific package
```

### Vendor Dependencies

```bash
moca vendor
```

Copies all dependencies to `vendor/` directory for offline builds.

## Dependency Cache

Dependencies are cached in:
- Linux: `~/.cache/moca/deps/`
- macOS: `~/Library/Caches/moca/deps/`
- Windows: `%LOCALAPPDATA%\moca\deps\`

## Example Workflow

### Create a New Project

```bash
$ moca init myapp
Created project 'myapp'

$ cd myapp
$ cat pkg.toml
[package]
name = "myapp"
version = "0.1.0"
entry = "src/main.mc"

[dependencies]

$ cat src/main.mc
print("Hello, World!");
```

### Add a Dependency

```bash
$ moca add https://github.com/user/moca-json@v1.0.0
Added json v1.0.0

$ cat pkg.toml
[package]
name = "myapp"
version = "0.1.0"
entry = "src/main.mc"

[dependencies]
json = { git = "https://github.com/user/moca-json", tag = "v1.0.0" }
```

### Use the Dependency

```moca
// src/main.mc
import json;

let data = json.parse('{"name": "moca"}');
print(data.name);
```

### Run the Project

```bash
$ moca run
moca
```
