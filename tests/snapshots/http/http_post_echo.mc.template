// HTTP POST echo test
// This test sends a POST request to /echo and receives the same body back

// Create socket (AF_INET=2, SOCK_STREAM=1)
let fd = socket(AF_INET(), SOCK_STREAM());
if fd < 0 {
    print("Failed to create socket");
    print(fd);
}

if fd >= 0 {
    // Connect to local test server
    let result = connect(fd, "127.0.0.1", {{PORT}});
    if result < 0 {
        print("Failed to connect");
        print(result);
    }

    if result >= 0 {
        // Build HTTP POST request with JSON body
        let body = "{\"x\":123}";
        let headers = "POST /echo HTTP/1.1\r\nHost: localhost\r\nContent-Type: application/json\r\nContent-Length: " + to_string(len(body)) + "\r\nConnection: close\r\n\r\n";
        let request = headers + body;
        let written = write(fd, request, len(request));

        // Read response
        let response = read(fd, 4096);

        // Print response
        print(response);
    }

    // Close socket
    close(fd);
}
